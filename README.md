# record
加入了rcore的学习项目 心里十分激动  对之后的学习进行记录

## Prepare

首先我应该去借一些书籍 完成对rust的入门学习,之前已经学习了mips的实现,riscv的学习反而没那么难。加油!

## Toc

*七月*

* [Day   1    (2020-07-02)](#0)   
* [Day   2    (2020-07-03)](#1)
* [Day   3    (2020-07-04)](#2)
* [Day   4    (2020-07-05)](#3)
* [Day   5    (2020-07-06)](#4)
* [Day   6    (2020-07-07)](#5)
* [Day   7~9  (2020-07-08)](#6)
* [Day   10   (2020-07-11)](#7)
* [Day   11   (2020-07-12)](#8)
* [Day   12   (2020-07-13)](#9)
* [Day   13   (2020-07-14)](#10)
* [Day   14   (2020-07-15)](#11)
* [Day   15   (2020-07-16)](#12)
* [Day   16   (2020-07-17)](#13)
* [Day   17   (2020-07-18)](#14)
* [Day   18   (2020-07-19)](#15)
* [Day   19   (2020-07-20)](#16)
* [Day   20   (2020-07-21)](#17)
* [Day   21   (2020-07-22)](#18)
* [Day   22   (2020-07-23)](#19)
* [Day   23   (2020-07-24)](#20)
* [Day   24   (2020-07-25)](#21)
* [Day   25   (2020-07-26)](#22)
* [Day   26   (2020-07-27)](#23)
* [Day   27   (2020-07-28)](#24)
* [Day   28   (2020-07-29)](#25)
* [Day   29   (2020-07-31)](#26)

*八月*
* [Day   30   (2020-08-03)](#27)
* [Day   31   (2020-08-04)](#28)
* [Day   32   (2020-08-05)](#29)
* [Day   33   (2020-08-06)](#30)
<span id="0"></span>
## Day 1
### 计划
   1、通过阅读 Rust by Example学习基础语法     
   2、阅读部分Rust编程之道       
   3、做一些编程题     

### 成果 
   1、<<通过例子学Rust>>  看到了闭包  有些卡住了 trait的含义没有理解 明天通过<<rust编程之道>>好好研究一下        
   2、前面的有些概念与之前学过的语言截然不同，思维的转变需要一些时间        
   3、没有开始做编程题，还需要理论的巩固      
    
    
<span id="1"></span>
## Day 2
### 计划
   1、完成基础语法的学习      
   2、将<<Rust编程之道>>上的章节仔细研究下     
   3、完成一部分编程题       
    
### 成果
   1、完成了基本语法的学习,对rust有了一个直观的认识          
   2、仔细阅读了<<rust 编程之道>>第三章,从抽象类型开始就晕了,有点搞不清楚原理，看来得做一些题练一下了      
   3、解决了昨天的一些疑惑,晚上要准备期末考试了😭        

<span id="2"></span>
## Day 3
### 计划
   1、完成第四章第五章的阅读     
   2、整理昨天的问题      
   因为今天考试了  所以进度不太理想--     😭
### 成果
   1、基本完成了第四章第五章的阅读，但是并没有完全吃透，还需要多读几遍，好书不厌百回读啊     
   2、把昨天的问题基本都搞明白了      
   3、所有权还真是个好东西，就是生命周期有点绕     
  
<span id="3"></span>
## Day 4
### 计划
   1、完成编程rustling上的程序题，对所学知识进行巩固    
   2、第九、十、十三章的内容稍微往后放一下    

### 成果
   1、小练习基本都完成了，还有个别的存在一些问题    
   2、rust编程之道上的 unsafe还没有看 其他的都看的差不多了 多写多练就行了         
   3、之前看的好多都忘了  还需要更多的记忆         
   
<span id="4"></span>
## Day 5
### 计划
   1、将rustling上存在的问题解决     
   2、准备看笨方法学c语言      
   3、看unsafe块的讲解     
   4、将之前所看知识再看一遍 记一下    
### 成果
   今天啥也没搞  一直在弄期末 /(ㄒoㄒ)/~~  这两天考试太多了  需要暂时放慢进度了      

<span id="5"></span>
## Day 6
### 计划
   完成昨天的计划     
### 成果
   1、看了unsafe     
   2、订下了要做的习题
<span id="6"></span>   
## Day 7~9
   夺命连环考试 /(ㄒoㄒ)/~~  接下来几天努力赶进度
   
<span id="7"></span>
## Day 10
### 计划
   1、将令狐一冲的视频刷一遍     
   2、将剩下的习题做完
### 成果
   1、令狐一冲基础过了一遍         
   2、剩下的习题基本做完 

<span id="8"></span>
## Day 11
### 计划
   1、将令狐一冲的进阶版选择一部分看        
   2、将剩下的习题做完
   3、开始笨方法学C语言
### 成果
   1、令狐一冲进阶看了一部分              
   2、rustling做完
  
<span id="9"></span>
## Day 12  
### 计划
   1、做leetcode上的题 大概2~3道    
   2、看一遍riscv     
   3、看一下lab
### 成果
   1、做了两道题     
   2、riscv大概看了一下     
   3、lab0弄了一部分
   
   
<span id="10"></span>
## Day 13  
### 计划
   1、做leetcode上的题 大概2~3道    
   2、看一遍riscv     
   3、看一下lab

### 成果
   1、没有做题 打算先搞lab       
   2、riscv特权看完了      
   3、环境配置完毕  lab0做完 lab1看了一遍
   
<span id="11"></span>
## Day 14 
### 计划
   1、做lab1     
   2、看lab2     
   3、leetcode的题等到之后再做
### 成果
   1、lab0写了实验报告 还有一些小问题           
   2、lab1做了一部分     
   
   
<span id="12"></span>
## Day 15 
### 计划
   1、将lab0小问题解决     
   2、写lab1实验报告     
   3、预习lab2
### 成果
   1、lab0残留一些没什么影响的问题 留到实验之后解决         
   2、lab1实验报告 √           
   3、预习lab2 √    
   
<span id="13"></span>
## Day 16 
### 计划
   1、写lab2实验报告         
   2、完成一部分lab2实验题            
   3、预习lab3
### 成果
   实验二感觉需要一定的时间--    
   
<span id="14"></span>
## Day 17 
### 计划
   1、完成lab2实验题            
   2、预习lab3
### 成果
   1、实验二大致理清楚了    
   2、线段树算法写了80%  打算先做实验三      
   
<span id="15"></span>
## Day 18 
### 计划
   1、完成lab3            
### 成果
   1、lab3感觉很晕  今天有点小事情  所以没什么进展
   
<span id="16"></span>
## Day 19 
### 计划
   1、完成lab3    
### 成果
   2、lab3基本完成  不过那个汇编我是真没看懂--       仔细琢磨下！
<span id="17"></span>   
## Day 20
### 计划
   1、学习lab4
  
### 成果
   重新看了点汇编的知识，并且将整个lab4过了一遍      
   感觉最近很浮躁，不是很能看下去，研究fpga吗?
   
<span id="18"></span>   
## Day 21
   ### 计划
   1、做lab4习题
   
   ### 成果
   做了一部分习题     
   最后还是决定去研究rcore的移植，目前是一头雾水
   
<span id="19"></span>   
## Day 22
   ### 计划
   研究fpga移植
   ### 成果
   自己终于把lab4搞出来了，这个文档简直劝退。。。 而且lab5好像也是。。。  不过起码把lab4搞明白了 lab4->lab5好像还要修改线程 吐了啊    
   fpga今天没有来得及看
   
<span id="20"></span>   
## Day 23
   ### 计划
   完成线段树以及线程的习题
   
   ### 成果
   基本都完成了  但是fork那里还有点问题      
   线段树之前想的太复杂了  现在改成一次分配一个内存空间  很容易就解决了      
   调度算法也有点坑。。。  最后在Thread.rs加了优先级属性才好一点      
   
<span id="21"></span>   
## Day 24
   ### 计划
   完成lab5、lab6 以及习题     
   
   ### 成果
   习题基本都完成了  还有些拓展的习题没有做，留到明天做一部分，今天因为clone的原因 琢磨了半天。。。
   
<span id="22"></span>   
## Day 25
   ### 计划
   完成一部分拓展习题 将docx改成md格式  并且将实验文件夹上传
   ### 成果
   研究了半天置换算法，卡在了给时钟算法标记sign的地方。。。下午把总结报告写了些，格式弄了下，暂时告一段落了，明天歇一天！


<span id="23"></span>   
## Day 26
   ### 计划
   暂时休息一天
   ### 成果
   结果还是没闲住，把置换算法给写了，明天就要找回状态了
   

<span id="24"></span>   
## Day 27
   ### 计划
   1 看一下zcore     
   2 研究fpga
   ### 成果
   稍微看了下，有点其他的事情，就没怎么多看
   
<span id="25"></span>   
## Day 28
  ### 计划
   1 看一下zcore     
   2 研究fpga
  ### 成果
   fpga没有找到很好的教程，对于移植还是一头雾水

<span id="26"></span>   
## Day 29
   ### 计划
   1 重新看一下rust  将语法总结一遍
   ### 成果
   对rust理解多了些 可能有利于之后的学习

<span id="27"></span>   
## Day 30
从 8-1到8-3没干什么事情。。我觉得我需要反省下，今日在向老师的指导下初步分了组      
我选的是k210移植方向，一直对这个感兴趣，希望能在这个方向做点成果吧，单核上跑rCore肯定是要弄的，至于多核，看之后的时间安排吧

<span id="28"></span>   
## Day 31
今天的日程是国科大的团队进行报告，在复现吴一凡学长的lab2项目中出现了神奇的bug      
发现在ubuntu上无法跑，但是在wsl中能够跑，很神奇。。         
尝试复现  更换riscv的指令集从 imac->gc 发现可以跑了   但是怎么会跟指令集有关系呢？      
之后查看汇编内容  发现stack居然在bss段中。。然后将stack清了  怪不得报错    
更改了内容之后可以顺利的跑起来了     


<span id="29"></span>   
## Day 32
今天的日程是       
去清华伯努利参观并参加报告      
在向老师的指导下细化了研究方向，打算继续搞rCore-Tutorial  尝试复现lab3 发现有很多问题。。慢慢搞吧

<span id="30"></span>   
## Day 33
这里是我的rCore移植的地址：
   https://github.com/freheit889/rCore-Tutorial

### 今日记录：

在大页表建立过之后，尝试将mapping加入其中，进行内核的重映射。
在确认无语法错误之后，测试在k210上输出

输出错误
```      
virtual address is already mapped   
```
尝试找出错误，发现在kernel_end到memory_end之间的地址空间已经被映射? 很神奇

更细化的找出问题 在map中    
```
0xffffffff8013c
0xffffffff8013c
```
这个地址出现了两次???   最后发现是在linker.ld中在kernel_end之前没有对齐      
加上`. = ALIGN(4K);`就没有这个bug了

之后在activate报错  后来发现1.9版本中没有mtval寄存器  我们需要将异常处理的代码在opensbi中进行处理 
在opensbi中加入一些代码
```
uintptr_t epc = csr_read(CSR_MEPC) - 0xffffffff80000000u + 0x80000000u;
ulong insn = *(uint32_t*)epc;
```

就可以跑通了！     


#### 将lab4下的文件夹搞过来  确认无语法错误之后 进行调试    
出现了 `InstructionFault` 现在要找下问题的原因     
改了下 `entry.asm` 发现出现了其他的问题    
```
sbi_trap_error: hart0: misaligned store handler failed (error -10)
sbi_trap_error: hart0: mcause=0x0000000000000006 mtval=0xffffffff80029274
sbi_trap_error: hart0: mepc=0xffffffff80027d94 mstatus=0x0000000000000820
sbi_trap_error: hart0: ra=0x4605122861142ea5 sp=0xffffffff80029254
sbi_trap_error: hart0: gp=0x80e7ffffc0974701 tp=0x00971228a009bc40
sbi_trap_error: hart0: s0=0xef2a1308f32ad725 s1=0x0000b61724a13823
sbi_trap_error: hart0: a0=0x85b2e8aeb9860613 a1=0x2a4080e7fffff097
sbi_trap_error: hart0: a2=0x6526a009e0aee4aa a3=0xd617eb2e6586e72a
sbi_trap_error: hart0: a4=0x621c326606130000 a5=0x4705033446090aa8
sbi_trap_error: hart0: a6=0xc0977862fc3a65c6 a7=0xa009b32080e7ffff
sbi_trap_error: hart0: s2=0x80e7000000970aa8 s3=0x0000d517a00972c0
sbi_trap_error: hart0: s4=0xa517610c33050513 s5=0x8131d06505130019
sbi_trap_error: hart0: s6=0x3c23f7aa1b88fbaa s7=0x06130000b61724a1
sbi_trap_error: hart0: s8=0xf09785b2f82eb2a6 s9=0xf42a236080e7ffff
sbi_trap_error: hart0: s10=0xefaa7522a009f02e s11=0x0000d617f3ae7582
sbi_trap_error: hart0: t0=0xa009798080e70000 t1=0x324505130000d517
sbi_trap_error: hart0: t2=0x05130019a517610c t3=0x1328621c2b860613
sbi_trap_error: hart0: t4=0x75c247050bb44609 t5=0xffffc0976862ec3a
sbi_trap_error: hart0: t6=0x1328a009ac4080e7
```
后来发现是因为hanler里没有处理好      

之后可以开始进行线程，当线程数大于2  就会出现           
`virtual address is already mapped`

当线程数等于1  就会出现     
```
Thread {
    thread_id: 0x2,
    stack: Range {
        start: VirtualAddress(
            0x1000000,
        ),
        end: VirtualAddress(
            0x1008000,
        ),
    },
    context: None,
} terminated: unimplemented interrupt type
cause: Exception(StoreFault), stval: 1007ff8
```
#### 猜测是因为内存分配出现了问题   

果然是内存分配  之前在qemu中 所有的内存都是可用的，但是在k210中 一些内存空间是用不了的，之后将线程分配内存放在可用空间内，可以跑起来一个线程，但是在多线程时还是会产生问题     
`virtual address is already mapped`

这是为什么？不是有重叠区域检测吗 

在range.rs中 判断重叠是这样的     
```
self.start.into() < other.end.into() && self.end.into() > other.start.into()
```
在k210的移植中修改为<=即解决了当前的问题，但是尝试在qemu中复现没有这个问题了?那么神奇的吗    

